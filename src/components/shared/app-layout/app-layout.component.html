<!-- AppLayout - Bazowy layout dla stron zalogowanych użytkowników -->
<!-- Wzorzec: PrimeBlocks Branded Navigation z hamburger menu -->

<div class="app-layout bg-surface-50">
  <!-- Navbar -->
  <!-- Wzorzec: PrimeBlocks "Hover Borders" -->
  <nav class="bg-surface-0 border-b border-surface-200">
    <div class="max-w-screen-xl mx-auto px-6 md:px-8 h-16 flex items-center lg:items-stretch justify-between relative lg:static gap-4 lg:gap-8">
    <!-- Lewa sekcja: Logo -->
    <a
      href="/"
      class="flex items-center gap-3 cursor-pointer shrink-0"
      aria-label="Spin Flow - strona główna"
    >
      <img
        [src]="logoPath()"
        alt="Spin Flow Logo"
        width="32"
        height="32"
        class="block"
      />
      <span class="text-lg font-semibold text-surface-900">Spin Flow</span>
    </a>

    <!-- Desktop: Menu główne (widoczne tylko na lg+) -->
    <!-- Wzorzec: PrimeBlocks "Hover Borders" -->
    <div class="hidden lg:flex flex-1 items-end gap-2 h-full">
      @for (item of menuItems(); track item.href; let i = $index) {
        <a
          [href]="item.href"
          [class]="getMenuItemClassDesktop(i)"
          (click)="setActiveItem(i)"
        >
          @if (item.icon) {
            <i [class]="'pi ' + item.icon + ' text-base ' + getMenuIconClass(i)"></i>
          }
          <span [class]="getMenuLabelClass(i)">{{ item.label }}</span>
        </a>
      }
    </div>

    <!-- Prawa sekcja header -->
    <div class="flex items-center gap-3">
      <!-- Dark Mode Toggle (zawsze widoczny) -->
      <a
        class="flex items-center justify-center p-2 bg-surface-0 rounded-lg border border-surface-200 hover:bg-surface-100 cursor-pointer transition-colors"
        (click)="toggleDarkMode()"
        [attr.aria-label]="themeService.isDarkMode() ? 'Przełącz na tryb jasny' : 'Przełącz na tryb ciemny'"
      >
        <i [class]="darkModeIconClass()"></i>
      </a>

      <!-- Desktop: User section (ukryte na mobile) -->
      <div class="hidden lg:flex items-center gap-3">
        <!-- Separator -->
        <div class="nav-separator bg-surface-200"></div>

        <!-- User menu trigger -->
        <div
          class="flex items-center gap-3 ml-2 cursor-pointer"
          (click)="userMenu.toggle($event)"
          [attr.aria-label]="'Menu użytkownika'"
          [attr.aria-haspopup]="true"
        >
          <p-avatar
            [image]="effectiveAvatarUrl() || undefined"
            [label]="effectiveAvatarUrl() ? undefined : (userInitials() || undefined)"
            [icon]="!effectiveAvatarUrl() && !userInitials() ? 'pi pi-user' : undefined"
            shape="circle"
            [styleClass]="avatarStyleClass()"
            (onImageError)="onAvatarImageError()"
          />
          @if (userName()) {
            <span class="text-surface-800 font-medium">
              {{ userName() }}
            </span>
          }
          <i class="pi pi-chevron-down text-xs text-surface-500"></i>
        </div>

        <!-- User popup menu (desktop) -->
        <p-menu
          #userMenu
          [model]="userMenuItems()"
          [popup]="true"
          appendTo="body"
        >
          <ng-template pTemplate="item" let-item>
            <a
              [attr.href]="item.url"
              [attr.target]="item.target"
              class="p-menuitem-link flex align-items-center px-3 py-2 text-color hover:surface-100 hover:text-color cursor-pointer no-underline"
              [class.text-green-600]="item.label === 'Wyloguj się'"
              (click)="item.command ? item.command($event) : null"
            >
              @if (item.icon) {
                <span class="p-menuitem-icon pi mr-2" [class]="item.icon"></span>
              }
              <span class="p-menuitem-text" [class.text-green-600]="item.label === 'Wyloguj się'">{{ item.label }}</span>
            </a>
          </ng-template>
        </p-menu>
      </div>

      <!-- Mobile: Hamburger button + dropdown -->
      <a
        #menuToggle
        pStyleClass="@next"
        enterFromClass="hidden"
        leaveToClass="hidden"
        [hideOnOutsideClick]="true"
        class="flex lg:hidden items-center justify-center p-2 cursor-pointer text-surface-700"
        aria-label="Toggle menu"
      >
        <i class="pi pi-bars text-xl"></i>
      </a>

      <!-- Mobile menu dropdown (musi być bezpośrednio po hamburgerze dla pStyleClass="@next") -->
      <div
        class="hidden absolute w-full bg-surface-0 left-0 top-full z-50 shadow-lg border-b border-surface-200 flex-col lg:!hidden"
      >
        <!-- Menu główne (mobile) -->
        <!-- Wzorzec: PrimeBlocks "Hover Borders" - border-left -->
        <div class="flex flex-col gap-0 px-0 py-4">
          @for (item of menuItems(); track item.href; let i = $index) {
            <a
              [href]="item.href"
              [class]="getMenuItemClassMobile(i)"
              (click)="setActiveItem(i)"
            >
              @if (item.icon) {
                <i [class]="'pi ' + item.icon + ' text-base ' + getMenuIconClass(i)"></i>
              }
              <span [class]="getMenuLabelClass(i)">{{ item.label }}</span>
            </a>
          }
        </div>

        <!-- Dolna sekcja: User info + Logout -->
        <div class="flex items-center justify-between gap-4 px-6 py-4 border-t border-surface-200">
          <!-- User info -->
          <div class="flex items-center gap-3">
            <p-avatar
              [image]="effectiveAvatarUrl() || undefined"
              [label]="effectiveAvatarUrl() ? undefined : (userInitials() || undefined)"
              [icon]="!effectiveAvatarUrl() && !userInitials() ? 'pi pi-user' : undefined"
              shape="circle"
              [styleClass]="avatarStyleClass()"
              (onImageError)="onAvatarImageError()"
            />
            @if (userName()) {
              <span class="text-surface-800 font-medium">
                {{ userName() }}
              </span>
            }
          </div>

          <!-- Logout button (zielony link na mobile) -->
          <a
            class="flex items-center gap-2 px-3 py-2 cursor-pointer transition-colors text-primary-500 hover:text-primary-600 font-medium"
            (click)="onLogoutClick()"
          >
            <span>Wyloguj</span>
          </a>
        </div>
      </div>
    </div>
    </div>
  </nav>

  <!-- Toast dla powiadomień -->
  <p-toast />

  <!-- Dialog potwierdzenia (globalny) -->
  <p-confirmDialog />

  <!-- Główna zawartość strony (ng-content) -->
  <main class="app-content bg-surface-50">
    <div class="max-w-screen-xl mx-auto px-6 md:px-8 py-6 md:py-8">
      <ng-content></ng-content>
    </div>
  </main>
</div>
