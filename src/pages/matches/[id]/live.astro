---
import Layout from '@/layouts/Layout.astro';
import { LiveMatchPageComponent, type LiveMatchPageComponentProps } from '@/components/live-match/live-match-page/live-match-page.component';

/**
 * Live Match Page - Widok meczu "W toku"
 * Służy do rejestracji przebiegu meczu tenisa stołowego na żywo.
 *
 * Route: /matches/:id/live
 * Access: Chroniony - wymaga autentykacji (middleware sprawdza automatycznie)
 * Validation: Weryfikacja ownership meczu + redirect do summary jeśli zakończony
 */

const { id } = Astro.params;

// Walidacja parametru ID
if (!id || isNaN(Number(id))) {
  return Astro.redirect('/matches');
}

const matchId = Number(id);

// Middleware już sprawdza autentykację automatycznie
// Tutaj tylko pobieramy dane użytkownika dla UI

const supabase = Astro.locals.supabase;
const { data: { user } } = await supabase.auth.getUser();

// Pobranie danych użytkownika dla layoutu
const userName = user?.user_metadata?.full_name || user?.email || 'Trener';
const userEmail = user?.email || '';
const userInitials = userName
  .split(' ')
  .map(n => n[0])
  .join('')
  .toUpperCase()
  .slice(0, 2);

export const prerender = false;

// Props dla komponentu Angular
const props: LiveMatchPageComponentProps = {
  matchId,
  userName,
  userEmail,
  userInitials,
};
---

<Layout title="Mecz - Spin Flow">
  <LiveMatchPageComponent client:only="angular" {...props} />
</Layout>

